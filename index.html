<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEF v1.3.8 - Mr Shake Hub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;800&family=Inter:wght@100;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Bibliotecas Core -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --glass: rgba(255, 255, 255, 0.7); }
        body { font-family: 'Inter', sans-serif; background-color: #FBFBFD; color: #1d1d1f; -webkit-font-smoothing: antialiased; margin: 0; overflow-x: hidden; }
        .font-baloo { font-family: 'Baloo 2', cursive; }
        .glass-card { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 20px; transition: all 0.3s ease; }
        .glass-card:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .ai-button { background: #000; color: #fff; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255,255,255,0.1); }
        .ai-button:hover { background: #333; transform: scale(1.02); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .exec-report { background: white; color: #1d1d1f; padding: 40px 60px; max-width: 850px; margin: 0 auto; line-height: 1.8; font-size: 15px; font-weight: 400; text-align: left; box-shadow: 0 10px 40px rgba(0,0,0,0.05); border-radius: 4px; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.05); } }
        .animate-neural { animation: pulse-soft 4s infinite ease-in-out; }
        .data-font { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #e5e5e7; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURAÃ‡Ã•ES E CONSTANTES GLOBAIS ---
        const LOGO_URL = "https://i.ibb.co/1f2w8RLy/mrshake-logo.png";
        const APP_VERSION = "1.3.8";
        const ADMIN_KEY = "305106112Aa@"; 
        const geminiApiKey = "AIzaSyAF8DvJ0rYKoavPMi7bBCYP1ZVJqCsR5JA"; 

        const { useState, useEffect, useMemo, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } = window.Recharts;

        const myFirebaseConfig = {
            apiKey: "AIzaSyDqdNy8xSDH75dPcKhXTHmG0pwhZ4mwNrs",
            authDomain: "pef-mrshake.firebaseapp.com",
            projectId: "pef-mrshake",
            storageBucket: "pef-mrshake.firebasestorage.app",
            messagingSenderId: "657478416938",
            appId: "1:657478416938:web:e89fe301b1629f9ea5a153"
        };

        const CLASSIFICACOES = {
            COMITE: { color: '#a855f7' }, 
            BRONZE: { color: '#A97142' }, 
            PRATA: { color: '#8e8e93' },
            OURO: { color: '#ffb300' },
            DIAMANTE: { color: '#0071e3' }
        };

        const CONSULTOR_IMAGES = {
            "Daniel": "https://i.ibb.co/bfHn7gW/daniel.jpg",
            "Roque": "https://i.ibb.co/k6DXFGdc/roque.jpg",
            "Karlla": "https://i.ibb.co/214SngTX/karlla.jpg"
        };

        const isProduction = !window.location.hostname.includes('googleusercontent') && 
                             !window.location.hostname.includes('localhost');

        const APP_ID = typeof window.__app_id !== 'undefined' ? window.__app_id : 'mr-shake-pef-storage';

        // --- UTILITÃRIOS ---
        const parseVal = (v) => {
            if (v === null || v === undefined || v === '') return 0;
            if (typeof v === 'number') return v;
            let c = String(v).replace(/[R$%\s]/g, "").replace(/\./g, "").replace(",", ".");
            return parseFloat(c) || 0;
        };

        const mapConsultor = (name) => {
            const n = String(name || "").toUpperCase();
            if (n.includes("DANIEL LUIS")) return "Daniel";
            if (n.includes("ROQUE DO CARMO")) return "Roque";
            if (n.includes("KARLLA LIMA")) return "Karlla";
            return "Outros";
        };

        // --- COMPONENTES AUXILIARES ---
        const CustomTooltip = ({ active, payload, total }) => {
            if (active && payload && payload.length) {
                const val = payload[0].value;
                const perc = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                return (
                    <div className="bg-white border border-slate-100 p-3 rounded-xl shadow-xl text-left border-l-4" style={{borderLeftColor: payload[0].fill}}>
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">{payload[0].payload.name}</p>
                        <p className="text-lg font-black text-slate-900 leading-none">{val} Unidades</p>
                        <p className="text-[10px] font-bold text-purple-600 mt-1">{perc}% do total</p>
                    </div>
                );
            }
            return null;
        };

        const Icon = ({ name, size = 18, color = "currentColor" }) => {
            const icons = {
                neural: (
                    <g fill="none" stroke={color} strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round">
                        <circle cx="12" cy="12" r="2" fill={color}/>
                        <circle cx="12" cy="5" r="2"/><circle cx="12" cy="19" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="19" cy="12" r="2"/>
                        <path d="M12 7v3m0 4v3M7 12h3m4 0h3M6.5 6.5l2 2m7 7l2 2M6.5 17.5l2-2m7-7l2 2"/>
                    </g>
                ),
                x: <path d="M18 6L6 18M6 6l12 12" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                lock: <path d="M7 11V7a5 5 0 0 1 10 0v4M5 11h14v10H5z" fill="none" stroke={color} strokeWidth="1.2"/>,
                unlock: <path d="M7 11V7a5 5 0 0 1 8-4M5 11h14v10H5z" fill="none" stroke={color} strokeWidth="1.2"/>,
                import: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5 5 5-5m-5 5V3" fill="none" stroke={color} strokeWidth="1.2"/>,
                trash: <path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke={color} strokeWidth="1.2"/>
            };
            return <svg width={size} height={size} viewBox="0 0 24 24" fill="none">{icons[name] || icons.neural}</svg>;
        };

        const EvolutionCard = ({ title, list, targetColor, nextPts }) => (
            <div className="glass-card p-5 flex-1 min-w-[280px] text-left">
                <div className="flex items-center justify-between mb-4">
                    <span className="text-[9px] font-bold uppercase tracking-[0.2em] text-[#86868b]">{title}</span>
                    <div className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: targetColor }} />
                </div>
                <div className="space-y-2">
                    {list.length > 0 ? list.map((loja, i) => (
                        <div key={i} className="flex items-center justify-between group">
                            <div className="text-left">
                                <div className="text-xs font-semibold text-[#1d1d1f] group-hover:text-purple-600 transition-colors"><strong>{loja.cidade}</strong></div>
                                <div className="text-[9px] font-medium text-[#86868b]">Faltam {(nextPts - parseVal(loja.total)).toFixed(2)} pts</div>
                            </div>
                            <div className="text-sm font-bold text-[#1d1d1f] data-font">{parseVal(loja.total).toFixed(2)}</div>
                        </div>
                    )) : <div className="py-2 text-[9px] text-[#d2d2d7] italic uppercase text-center">ConcluÃ­do</div>}
                </div>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAdminModal, setShowAdminModal] = useState(false);
            const [adminInput, setAdminInput] = useState('');
            const [loginError, setLoginError] = useState(false);
            const [view, setView] = useState('dashboard');
            const [dashTab, setDashTab] = useState('resumo');
            const [historicoPef, setHistoricoPef] = useState([]);
            const [periodoAlvoId, setPeriodoAlvoId] = useState('');
            const [consultorAlvo, setConsultorAlvo] = useState('TODOS');
            const [showAiModal, setShowAiModal] = useState(false);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [saveError, setSaveError] = useState('');
            const [chatMessages, setChatMessages] = useState([]);
            const [userInput, setUserInput] = useState('');
            const [isDragging, setIsDragging] = useState(false);
            const [uploadSuccess, setUploadSuccess] = useState(false);
            const [novoMes, setNovoMes] = useState({ mes: '', ano: '2026', lojasProcessadas: [] });
            
            const fileInputRef = useRef(null);
            const chatEndRef = useRef(null);

            const activePeriodo = useMemo(() => historicoPef.find(x => x.id === periodoAlvoId) || null, [historicoPef, periodoAlvoId]);
            const processedData = useMemo(() => {
                if (!activePeriodo) return [];
                return (activePeriodo.lojas || [])
                    .map(l => ({...l, consultorMapeado: mapConsultor(l.consultor)}))
                    .filter(l => l.codigo && String(l.codigo) !== "0" && !String(l.cidade).toUpperCase().includes("TOTAL"));
            }, [activePeriodo]);

            const activeData = useMemo(() => {
                if (consultorAlvo === 'TODOS') return processedData;
                return processedData.filter(l => l.consultorMapeado === consultorAlvo);
            }, [processedData, consultorAlvo]);

            const finStats = useMemo(() => {
                let totalRede = 0, basePEF = 0, totalDesconto = 0, participantesPEF = 0;
                let counts = { COMITE: 0, BRONZE: 0, PRATA: 0, OURO: 0, DIAMANTE: 0 };
                activeData.forEach(l => {
                    const c = String(l.classe || "").toUpperCase();
                    if (counts[c] !== undefined) counts[c]++;
                    const fat = parseVal(l.faturamento);
                    totalRede += fat;
                    if (c !== 'COMITE') {
                        basePEF += fat;
                        participantesPEF++;
                        totalDesconto += (fat * 0.045 * (parseVal(l.desconto)/100));
                    }
                });
                return { totalRede, basePEF, royaltiesBrutos: basePEF * 0.045, totalDesconto, counts, total: activeData.length, participantesPEF };
            }, [activeData]);

            const evolucoes = useMemo(() => ({
                b_p: activeData.filter(l => String(l.classe).toUpperCase() === 'BRONZE' && parseVal(l.total) >= 50).sort((a,b) => parseVal(b.total) - parseVal(a.total)).slice(0, 5),
                p_o: activeData.filter(l => String(l.classe).toUpperCase() === 'PRATA' && parseVal(l.total) >= 68).sort((a,b) => parseVal(b.total) - parseVal(a.total)).slice(0, 5),
                o_d: activeData.filter(l => String(l.classe).toUpperCase() === 'OURO' && parseVal(l.total) >= 85).sort((a,b) => parseVal(b.total) - parseVal(a.total)).slice(0, 5),
            }), [activeData]);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        const envConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : null;
                        const finalConfig = (envConfig && !isProduction) ? envConfig : myFirebaseConfig;
                        if (firebase.apps.length === 0) firebase.initializeApp(finalConfig);
                        const auth = firebase.auth();
                        setDb(firebase.firestore());
                        if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token && !isProduction) {
                            await auth.signInWithCustomToken(window.__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { console.error("Firebase Auth Error"); }
                };
                initAuth();
                const unsub = firebase.auth().onAuthStateChanged(setUser);
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const unsub = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('periodos_pef')
                    .onSnapshot(snap => {
                        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        const sorted = data.sort((a, b) => b.criadoEm?.localeCompare(a.criadoEm));
                        setHistoricoPef(sorted);
                        if (sorted.length > 0 && !periodoAlvoId) setPeriodoAlvoId(sorted[0].id);
                    });
                return () => unsub();
            }, [user, db]);

            const handleSendMessage = async (msgOverride = null) => {
                const msg = msgOverride || userInput;
                if (!msg.trim()) return;
                const newMessages = [...chatMessages, { role: 'user', text: msg }];
                setChatMessages(newMessages);
                if (!msgOverride) setUserInput('');
                setIsAiLoading(true);

                // CompactaÃ§Ã£o de dados para permitir 150+ lojas
                const auditSummary = activeData
                    .map(l => `[${l.cidade},${parseVal(l.total)},${l.classe}]`)
                    .join('');

                const systemInstruction = `Analista Neural Mr Shake Hub. AtuaÃ§Ã£o executiva.
                DATASET: Periodo ${activePeriodo?.titulo} | Lojas Totais: ${finStats.total}.
                REGRAS: Analise TODAS as lojas enviadas. Priorize detalhar erros tÃ©cnicos de quem estÃ¡ no nÃ­vel BRONZE.
                REGRAS FORMATAÃ‡ÃƒO: CAIXA ALTA para TÃ­tulos e Lojas. Sem Markdown.
                DADOS BRUTOS: ${auditSummary}`;

                const fetchIA = async (attempt = 1) => {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                contents: newMessages.map(m => ({ 
                                    role: m.role === 'user' ? 'user' : 'model', 
                                    parts: [{ text: m.text }] 
                                })),
                                generationConfig: { temperature: 0.1, topP: 0.9, maxOutputTokens: 2000 },
                                systemInstruction: { parts: [{ text: systemInstruction }] } 
                            })
                        });

                        if (!res.ok) throw new Error(`API Error ${res.status}`);
                        return await res.json();
                    } catch (err) {
                        if (attempt < 4) {
                            await new Promise(r => setTimeout(r, 2000 * attempt));
                            return fetchIA(attempt + 1);
                        }
                        throw err;
                    }
                };

                try {
                    const result = await fetchIA();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Resposta vazia");
                    setChatMessages([...newMessages, { role: 'assistant', text }]);
                } catch (e) {
                    setChatMessages([...newMessages, { role: 'assistant', text: "Lamento, o volume de dados das 150+ lojas estÃ¡ instÃ¡vel no servidor neural. Por favor, tente novamente em instantes." }]);
                } finally { 
                    setIsAiLoading(false); 
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target?.files?.[0] || e.dataTransfer?.files?.[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                        const processed = rows.slice(1).map(r => ({
                            codigo: r[0] || "", cidade: r[1] || "Unidade", consultor: r[2] || "N/A",
                            financeiro: r[13] || 0, engajamento: r[15] || 0, syntax: r[17] || 0, oculto: r[18] || 0,
                            faturamento: r[19] || 0, meta: r[32] || 0, total: r[33] || 0, classe: r[34] || "BRONZE", desconto: r[35] || 0
                        })).filter(l => l.codigo && String(l.codigo) !== "0" && !String(l.cidade).toUpperCase().includes("TOTAL"));
                        setNovoMes(p => ({...p, lojasProcessadas: processed})); setUploadSuccess(true);
                    } catch (err) { setSaveError('Erro Excel.'); }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleSaveData = async () => {
                if (!novoMes.mes || !uploadSuccess || !user) return;
                setIsSaving(true);
                try {
                    await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('periodos_pef').add({
                        titulo: `${String(novoMes.mes).padStart(2, '0')}/${novoMes.ano}`,
                        criadoEm: new Date().toISOString(),
                        lojas: novoMes.lojasProcessadas
                    });
                    setUploadSuccess(false); setNovoMes({...novoMes, mes: ''}); setView('dashboard');
                } catch (e) { setSaveError('Erro Firebase.'); } finally { setIsSaving(false); }
            };

            return (
                <div className="min-h-screen pb-6 text-left">
                    <nav className="h-14 bg-[#1D1D1F]/90 backdrop-blur-xl sticky top-0 z-50 border-b border-black flex items-center justify-between px-6">
                        <div className="flex items-center gap-4">
                            <img src={LOGO_URL} className="h-7" />
                            <div className="h-5 w-[1px] bg-zinc-700"/>
                            <div className="text-left leading-none text-white font-bold uppercase tracking-tight text-lg">
                                Mr Shake Hub <span className="text-[8px] block text-zinc-500 font-normal uppercase tracking-[0.2em] mt-0.5">InteligÃªncia de NegÃ³cios</span>
                            </div>
                        </div>
                        <div className="flex gap-2 bg-zinc-800/40 p-1 rounded-xl border border-zinc-700/30">
                            <button onClick={()=>{setView('dashboard'); setDashTab('resumo');}} className={`px-4 py-1.5 rounded-lg text-[9px] font-bold transition-all ${view==='dashboard'?'bg-white text-black shadow-sm':'text-zinc-500 hover:text-white'}`}>Painel</button>
                            {isAdmin && (
                                <>
                                    <button onClick={()=>setView('upload')} className={`px-4 py-1.5 rounded-lg text-[9px] font-bold transition-all ${view==='upload'?'bg-white text-black shadow-sm':'text-zinc-500 hover:text-white'}`}>Importar</button>
                                    <button onClick={()=>setView('history')} className={`px-4 py-1.5 rounded-lg text-[9px] font-bold transition-all ${view==='history'?'bg-white text-black shadow-sm':'text-zinc-500 hover:text-white'}`}>Banco</button>
                                </>
                            )}
                            <button onClick={()=>isAdmin?setIsAdmin(false):setShowAdminModal(true)} className="p-1.5 text-zinc-400 hover:text-white transition-colors">{isAdmin ? <Icon name="unlock" size={14}/> : <Icon name="lock" size={14}/>}</button>
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto mt-6 px-6 text-left">
                        {view === 'dashboard' && (
                            <div className="animate-in fade-in duration-500">
                                <header className="flex justify-between items-end mb-6">
                                    <div className="text-left">
                                        <h1 className="text-3xl font-bold tracking-tighter uppercase text-left">PEF</h1>
                                        <p className="text-zinc-400 uppercase text-[9px] tracking-widest mt-0.5">gestao de performance</p>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        {consultorAlvo !== 'TODOS' && CONSULTOR_IMAGES[consultorAlvo] && <img src={CONSULTOR_IMAGES[consultorAlvo]} className="h-10 w-10 rounded-full border border-white shadow-sm"/>}
                                        <div className="flex gap-2">
                                            <select value={consultorAlvo} onChange={(e) => {setConsultorAlvo(e.target.value); setDashTab('resumo');}} className="bg-white border border-zinc-200 px-3 py-2 rounded-lg text-[9px] font-bold outline-none shadow-sm cursor-pointer text-left">
                                                <option value="TODOS">TODA A REDE</option>
                                                {Array.from(new Set(processedData.map(l => l.consultorMapeado))).filter(c=>c!=="Outros").map(c=><option key={c} value={c}>{c.toUpperCase()}</option>)}
                                            </select>
                                            <select value={periodoAlvoId} onChange={(e) => {setPeriodoAlvoId(e.target.value); setConsultorAlvo('TODOS'); setDashTab('resumo');}} className="bg-white border border-zinc-200 px-3 py-2 rounded-lg text-[9px] font-bold outline-none shadow-sm cursor-pointer">
                                                {historicoPef.map(p=><option key={p.id} value={p.id}>{p.titulo}</option>)}
                                            </select>
                                        </div>
                                        <button onClick={()=>{if(!activePeriodo) return; setShowAiModal(true); if(chatMessages.length===0) handleSendMessage("AuditÃ³rio Neural.");}} className="ai-button px-5 py-2.5 rounded-lg font-bold text-[9px] uppercase flex items-center gap-2 tracking-widest shadow-lg text-left"><div className="animate-neural"><Icon name="neural" size={14} color="white"/></div> Neural Intelligence</button>
                                    </div>
                                </header>

                                <div className="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                                    {[ 
                                        {l:'Faturamento Rede',v:finStats.totalRede}, 
                                        {l:'Base PEF',v:finStats.basePEF}, 
                                        {l:'Royalties Base',v:finStats.royaltiesBrutos}, 
                                        {l:'Descontos Pef',v:finStats.totalDesconto, c:true} 
                                    ].map((x,i)=>(
                                        <div key={i} className="glass-card p-4 flex flex-col justify-between">
                                            <span className="text-[8px] font-bold text-zinc-400 uppercase tracking-widest text-left">{x.l}</span>
                                            <span className={`text-lg font-black data-font ${x.c?'text-blue-600':''}`}>R$ {x.v.toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
                                        </div>
                                    ))}
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-6 gap-2 mb-6 text-center">
                                    <div onClick={()=>setDashTab('resumo')} className={`p-4 rounded-2xl border cursor-pointer transition-all flex flex-col items-center justify-center ${dashTab==='resumo'?'bg-black text-white shadow-md scale-105':'bg-white text-black'}`}>
                                        <span className="text-[8px] uppercase font-bold opacity-50 mb-0.5 text-center">Total</span>
                                        <span className="text-xl font-black text-center">{finStats.total}</span>
                                        <span className="text-[8px] opacity-40 font-bold text-center mt-1">100%</span>
                                    </div>
                                    {Object.keys(CLASSIFICACOES).map(c=>{
                                        const count = finStats.counts[c] || 0;
                                        const p = finStats.total > 0 ? ((count / finStats.total)*100).toFixed(1) : 0;
                                        return (
                                            <div key={c} onClick={()=>setDashTab(c.toLowerCase())} className={`p-4 rounded-2xl border cursor-pointer transition-all flex flex-col items-center justify-center ${dashTab===c.toLowerCase()?'ring-2 ring-black shadow-md':'bg-white text-zinc-400'}`}>
                                                <span className="text-[8px] uppercase font-bold mb-0.5 text-center" style={{color:dashTab===c.toLowerCase()?CLASSIFICACOES[c].color:'inherit'}}>{c}</span>
                                                <span className="text-xl font-black text-black text-center">{count}</span>
                                                <span className="text-[8px] text-zinc-400 font-bold text-center mt-1">({p}%)</span>
                                            </div>
                                        );
                                    })}
                                </div>

                                {dashTab === 'resumo' ? (
                                    <div className="space-y-6">
                                        <div className="glass-card p-6 h-[320px] relative text-left">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={Object.keys(CLASSIFICACOES).map(cls => ({ name: cls, value: finStats.counts[cls] || 0, fill: CLASSIFICACOES[cls].color }))} margin={{top: 10, bottom: 10}}>
                                                    <XAxis dataKey="name" fontSize={9} fontBold axisLine={false} tickLine={false} tick={{fill: '#86868b'}} dy={5}/><YAxis hide/><Tooltip cursor={{fill: '#f5f5f7'}} content={<CustomTooltip total={finStats.total}/>}/><Bar dataKey="value" radius={[10,10,10,10]} barSize={35}>{Object.keys(CLASSIFICACOES).map((c,i)=><Cell key={i} fill={CLASSIFICACOES[c].color}/>)}</Bar>
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                        <div className="flex flex-col md:flex-row gap-4">
                                            <EvolutionCard title="EvoluÃ§Ã£o Bronze â†’ Prata" list={evolucoes.b_p} targetColor={CLASSIFICACOES.PRATA.color} nextPts={60}/>
                                            <EvolutionCard title="EvoluÃ§Ã£o Prata â†’ Ouro" list={evolucoes.p_o} targetColor={CLASSIFICACOES.OURO.color} nextPts={76}/>
                                            <EvolutionCard title="EvoluÃ§Ã£o Ouro â†’ Diamante" list={evolucoes.o_d} targetColor={CLASSIFICACOES.DIAMANTE.color} nextPts={91}/>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="glass-card overflow-hidden">
                                        <table className="w-full text-left">
                                            <thead><tr className="bg-zinc-50 border-b border-zinc-100 text-[8px] font-bold text-zinc-400 uppercase tracking-widest text-left"><th className="p-4">Unidade</th><th className="p-4 text-right">Performance</th><th className="p-4 text-center">BenefÃ­cio</th></tr></thead>
                                            <tbody className="divide-y divide-zinc-50">
                                                {activeData.filter(l => l.classe.toLowerCase() === dashTab).sort((a,b)=>parseVal(b.total)-parseVal(a.total)).map((l, i) => (
                                                    <tr key={i} className="hover:bg-zinc-50 transition-colors">
                                                        <td className="p-4 font-bold text-black border-l-4 text-left" style={{borderColor: CLASSIFICACOES[dashTab.toUpperCase()]?.color}}><strong>{l.cidade}</strong></td>
                                                        <td className="p-4 text-right font-black data-font text-lg">{parseFloat(l.total).toFixed(2)}</td>
                                                        <td className="p-4 text-center text-[10px] font-bold text-zinc-400">{l.desconto}%</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'upload' && isAdmin && (
                            <div className="max-w-lg mx-auto glass-card p-10 text-center animate-in zoom-in duration-500">
                                <h2 className="text-2xl font-bold uppercase tracking-tighter mb-6">ImportaÃ§Ã£o</h2>
                                <div onDragOver={(e)=>{e.preventDefault();setIsDragging(true);}} onDragLeave={()=>setIsDragging(false)} onDrop={(e)=>{e.preventDefault();setIsDragging(false);handleFileUpload(e);}} onClick={()=>fileInputRef.current.click()} className={`border-2 border-dashed p-10 rounded-2xl cursor-pointer transition-all ${isDragging?'border-blue-500 bg-blue-50':'border-zinc-200'}`}>
                                    <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileUpload} accept=".xlsx,.xls"/>
                                    <div className="text-3xl mb-3 opacity-20 text-center">ðŸ“„</div>
                                    <span className="text-[9px] font-bold uppercase tracking-widest text-zinc-400 text-center">{uploadSuccess ? 'DADOS PRONTOS' : 'CARREGAR EXCEL'}</span>
                                </div>
                                <div className="grid grid-cols-2 gap-3 mt-6">
                                    <div><span className="text-[8px] font-bold text-zinc-400 uppercase ml-2 text-left">MÃªs</span><input type="number" value={novoMes.mes} onChange={e=>setNovoMes({...novoMes, mes: e.target.value})} className="w-full bg-white border border-zinc-200 p-2.5 rounded-lg text-center font-bold outline-none focus:border-black text-center"/></div>
                                    <div><span className="text-[8px] font-bold text-zinc-400 uppercase ml-2 text-left">Ano</span><input type="number" value={novoMes.ano} onChange={e=>setNovoMes({...novoMes, ano: e.target.value})} className="w-full bg-white border border-zinc-200 p-2.5 rounded-lg text-center font-bold outline-none focus:border-black text-center"/></div>
                                </div>
                                <button onClick={handleSaveData} disabled={isSaving} className={`w-full text-white py-4 rounded-xl mt-6 font-bold uppercase tracking-widest text-[9px] shadow-lg transition-all ${isSaving ? 'bg-zinc-400' : 'bg-black active:scale-95'}`}>{isSaving ? 'A GRAVAR...' : 'GRAVAR NO BANCO'}</button>
                            </div>
                        )}

                        {view === 'history' && isAdmin && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in duration-500 text-left">
                                {historicoPef.map(p=>(
                                    <div key={p.id} className="glass-card p-6 flex items-center justify-between">
                                        <div className="text-left">
                                            <h3 className="text-xl font-bold uppercase tracking-tighter text-[#1d1d1f] text-left">{p.titulo}</h3>
                                            <span className="text-[8px] font-bold text-zinc-400 uppercase tracking-widest text-left">{p.lojas?.length||0} unidades</span>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={async()=>{if(confirm('Eliminar?')) await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('periodos_pef').doc(p.id).delete();}} className="p-2.5 text-zinc-300 hover:text-red-500 bg-[#f5f5f7] rounded-lg"><Icon name="trash" size={18}/></button>
                                            <button onClick={()=>{setPeriodoAlvoId(p.id); setView('dashboard');}} className="p-2.5 bg-black text-white rounded-lg shadow-md"><Icon name="import" size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {showAiModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-white/90 backdrop-blur-xl animate-in fade-in duration-300 text-left">
                            <div className="bg-white border border-zinc-200 rounded-[24px] w-full max-w-5xl h-[85vh] flex flex-col shadow-2xl overflow-hidden text-left">
                                <div className="p-6 border-b border-zinc-100 flex justify-between items-center bg-white text-left">
                                    <div className="flex items-center gap-3 text-left"><div className="bg-black p-2.5 rounded-xl text-white shadow-lg text-left"><Icon name="neural" size={20}/></div><div className="text-left text-left"><h3 className="text-lg font-bold uppercase tracking-tighter text-left">Neural Intelligence</h3><p className="text-[8px] font-bold text-zinc-400 uppercase tracking-widest text-left">Auditoria TÃ©cnica</p></div></div>
                                    <button onClick={()=>setShowAiModal(false)} className="bg-zinc-50 p-2 rounded-full hover:bg-zinc-100 transition-colors text-left"><Icon name="x" size={20} color="#000" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-8 custom-scrollbar bg-zinc-50/30 text-left">
                                    {chatMessages.map((m,i)=>(
                                        <div key={i} className={`flex mb-8 ${m.role === 'user' ? 'justify-end' : 'justify-start'} text-left`}>
                                            {m.role === 'assistant' ? (
                                                <div className="exec-report shadow-xl whitespace-pre-wrap text-left" dangerouslySetInnerHTML={{__html: m.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}}></div>
                                            ) : (
                                                <div className="bg-[#1d1d1f] text-white p-5 rounded-2xl rounded-tr-none text-xs font-medium shadow-lg text-left">{m.text}</div>
                                            )}
                                        </div>
                                    ))}
                                    {isAiLoading && <div className="text-center py-8 animate-pulse uppercase text-[9px] font-black tracking-[0.4em] text-zinc-400 text-center">Neural Audit...</div>}
                                    <div ref={chatEndRef}/>
                                </div>
                                <div className="p-6 bg-white border-t border-zinc-100 text-left">
                                    <div className="max-w-4xl mx-auto flex gap-3 bg-zinc-100 p-2 rounded-2xl text-left">
                                        <input type="text" value={userInput} onChange={e=>setUserInput(e.target.value)} onKeyDown={e=>e.key==='Enter' && handleSendMessage()} placeholder="Mensagem..." className="flex-1 bg-transparent px-4 outline-none text-xs font-medium text-left"/>
                                        <button onClick={()=>handleSendMessage()} disabled={isAiLoading} className="bg-[#1d1d1f] text-white px-8 py-3 rounded-xl font-bold text-[9px] uppercase tracking-widest shadow-md active:scale-95 transition-all text-left">Enviar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAdminModal && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl animate-in fade-in text-center text-left">
                            <div className="bg-zinc-900 border border-zinc-800 p-12 rounded-[40px] w-full max-w-sm shadow-2xl text-center">
                                <h3 className="text-xl font-bold uppercase text-white mb-8 tracking-widest text-center">ACESSO</h3>
                                <input type="password" autoFocus value={adminInput} onChange={e=>{setAdminInput(e.target.value);setLoginError(false);}} onKeyDown={e=>e.key==='Enter'&&(adminInput===ADMIN_KEY? (setIsAdmin(true),setShowAdminModal(false),setAdminInput(''),setLoginError(false)) : setLoginError(true))} className={`w-full bg-black border ${loginError?'border-red-500':'border-zinc-800'} p-5 rounded-2xl text-center font-black text-lg text-white outline-none focus:bg-zinc-800 transition-all text-center`} placeholder="CHAVE"/>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={()=>setShowAdminModal(false)} className="flex-1 py-3 text-[9px] font-bold text-zinc-500 uppercase tracking-widest text-center">Sair</button>
                                    <button onClick={()=>(adminInput===ADMIN_KEY? (setIsAdmin(true),setShowAdminModal(false),setAdminInput(''),setLoginError(false)) : setLoginError(true))} className="flex-1 bg-white text-black py-3 rounded-xl text-[9px] font-bold uppercase tracking-widest shadow-xl text-center">Entrar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <footer className="mt-6 py-4 text-center opacity-30 text-[8px] font-black uppercase tracking-[0.4em] text-zinc-500 text-center">Mr. Shake Neural System â€¢ v{APP_VERSION}</footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
